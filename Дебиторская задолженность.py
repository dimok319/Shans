import pandas as pd
import xlwings as xw
import os
import glob
import time
import shutil  # для переноса старых файлов в архив
from datetime import datetime
from colorama import init, Fore  # для цветного вывода в консоль

# Инициализация colorama
init(autoreset=True)


def payment_by_region():
    start_time = time.time()

    # --- Шаг 1. Находим последний сохранённый файл в папке ---
    folder_path = r"\\192.168.1.211\Аналитический центр\Отчёты\ДЗ\Контроль сроков оплаты"
    # Получаем все файлы Excel в папке
    list_of_files = glob.glob(os.path.join(folder_path, 'Отчет по ДЗ*.xlsx'))
    # Выбираем файл с последним временем создания
    source_file = max(list_of_files, key=os.path.getctime)
    # Выводим в лог, какой файл выбран
    print(f"{Fore.GREEN}Выбранный файл для обработки: {source_file}")

    # --- Шаг 2. Словарь соответствия "Регион -> Дивизион" ---
    region_division_map = {
        "Азербайджан": "СНГ",
        "Алтайский край": "Дивизион СИБИРЬ",
        "Амурская область": "Дивизион ДАЛЬНИЙ ВОСТОК",
        "Астраханская область": "Дивизион ЮГ",
        "Белгородская область": "Дивизион ЦЕНТР",
        "Белоруссия": "СНГ",
        "Брянская область": "Дивизион ЦЕНТР",
        "Владимирская область": "Дивизион ЦЕНТР",
        "Волгоградская область": "Дивизион ЮГ",
        "Воронежская область": "Дивизион ЦЕНТР",
        "Грузия": "СНГ",
        "ДНР": "Дивизион ЦЕНТР",
        "Запорожье/Херсон": "Дивизион ЮГ",
        "Иркутская область": "Дивизион СИБИРЬ",
        "Казахстан": "СНГ",
        "Калининградская область": "Дивизион ЦЕНТР",
        "Кемеровская область": "Дивизион СИБИРЬ",
        "Кировская область": "Дивизион ПОВОЛЖЬЕ",
        "Краснодарский край 1": "Дивизион ЮГ",
        "Краснодарский край 2": "Дивизион ЮГ",
        "Красноярский край": "Дивизион СИБИРЬ",
        "Курганская область": "Дивизион УРАЛ",
        "Курская область": "Дивизион ЦЕНТР",
        "Липецкая область": "Дивизион ЦЕНТР",
        "ЛНР": "Дивизион ЦЕНТР",
        "ЛНР/ДНР": "Дивизион ЦЕНТР",
        "Московская область": "Дивизион ЦЕНТР",
        "Нижегородская область": "Дивизион ПОВОЛЖЬЕ",
        "Новосибирская область": "Дивизион СИБИРЬ",
        "Омская область": "Дивизион СИБИРЬ",
        "Оренбургская область": "Дивизион ПОВОЛЖЬЕ",
        "Орловская область": "Дивизион ЦЕНТР",
        "Пензенская область": "Дивизион ПОВОЛЖЬЕ",
        "Приморский край": "Дивизион ДАЛЬНИЙ ВОСТОК",
        "Республика Башкортостан": "Дивизион ПОВОЛЖЬЕ",
        "Республика Дагестан": "Дивизион ЮГ",
        "Республика Калмыкия": "Дивизион ЮГ",
        "Республика Крым": "Дивизион ЮГ",
        "Республика Мордовия": "Дивизион ПОВОЛЖЬЕ",
        "Республика Татарстан": "Дивизион ПОВОЛЖЬЕ",
        "Республика Чувашия": "Дивизион ПОВОЛЖЬЕ",
        "Ростовская область 1": "Дивизион ЮГ",
        "Ростовская область 2": "Дивизион ЮГ",
        "Рязанская область": "Дивизион ЦЕНТР",
        "Самарская область": "Дивизион ПОВОЛЖЬЕ",
        "Саратовская область": "Дивизион ПОВОЛЖЬЕ",
        "Свердловская область": "Дивизион УРАЛ",
        "Ставропольский край": "Дивизион ЮГ",
        "Тамбовская область": "Дивизион ЦЕНТР",
        "Томская область": "Дивизион СИБИРЬ",
        "Тульская область": "Дивизион ЦЕНТР",
        "Тюменская область": "Дивизион УРАЛ",
        "Ульяновская область": "Дивизион ПОВОЛЖЬЕ",
        "Челябинская область": "Дивизион УРАЛ",
        "Беларусь": "СНГ",
        "Армения": "СНГ"
    }

    # --- Шаг 3. Читаем исходные данные в DataFrame ---
    df = pd.read_excel(source_file, sheet_name='TDSheet', header=0)
    # Объединяем данные для Алтайского края 1 и Алтайского края 2
    df['Регион.Наименование'] = df['Регион.Наименование'].replace(
        {'Алтайский край 1': 'Алтайский край', 'Алтайский край 2': 'Алтайский край'})
    # Переопределяем "Дивизион" по словарю (если в исходном файле некорректно)
    df['Дивизион'] = df['Регион.Наименование'].map(region_division_map)
    # Убираем строки, где не удалось сопоставить "Дивизион"
    df = df.dropna(subset=['Дивизион'])

    # --- Шаг 4. Создаём приложение Excel и открываем книгу ---
    app_excel = xw.App(visible=False)  # visible=True, если нужно видеть процесс
    wb = xw.Book(source_file)
    # Лист, на который будем заливать фильтрованные данные
    sh_data = wb.sheets['TDSheet']

    # --- Шаг 5. Список всех дивизионов, которые встретились в df ---
    div_list = df['Дивизион'].unique().tolist()
    # Корневая папка, куда складываем все отчёты (уже существует на сетевом диске)
    root_dir = r"\\192.168.1.211\торговый дом"

    # --- Шаг 6. Цикл по дивизионам ---
    for division in div_list:
        # Пропускаем дивизион СНГ
        if division == "СНГ":
            continue

        # Папка дивизиона
        division_dir = os.path.join(root_dir, division)
        os.makedirs(division_dir, exist_ok=True)

        # Отбираем данные по текущему дивизиону
        df_div = df.loc[df['Дивизион'] == division].reset_index(drop=True)
        # Получаем список регионов в данном дивизионе
        reg_list = df_div['Регион.Наименование'].unique().tolist()

        # --- Шаг 7. Цикл по регионам ---
        for region in reg_list:
            # Запись времени начала обработки региона
            region_start_time = time.time()

            # Папка региона
            region_dir = os.path.join(division_dir, region)
            os.makedirs(region_dir, exist_ok=True)

            # Папка "Дебиторская задолженность"
            debt_dir = os.path.join(region_dir, "Дебиторская задолженность")
            os.makedirs(debt_dir, exist_ok=True)

            # Папка "Отчеты"
            reports_dir = os.path.join(debt_dir, "Отчеты")
            os.makedirs(reports_dir, exist_ok=True)

            # Папка "Архив" внутри "Отчеты"
            archive_dir = os.path.join(reports_dir, "Архив")
            os.makedirs(archive_dir, exist_ok=True)

            # Переносим все старые отчёты в "Архив"
            old_reports = glob.glob(os.path.join(reports_dir, '*_Отчёт по ДЗ_*.xlsx'))
            new_date_str = datetime.today().strftime('%Y%m%d')  # Текущая дата в формате YYYYMMDD

            for rep in old_reports:
                if '~$' in rep:  # Исключаем временные файлы Excel
                    continue

                # Определяем путь для файла в архиве
                archive_file = os.path.join(archive_dir, os.path.basename(rep))
                # Извлекаем дату из имени файла (предполагается, что это первые 8 символов)
                filename = os.path.basename(rep)
                file_date_str = filename[:8]

                # Если в архиве уже есть файл с такой датой (и дата не сегодняшняя),
                # удаляем файл из основной папки, оставляя только новый файл.
                if os.path.exists(archive_file) and file_date_str != new_date_str:
                    try:
                        os.remove(rep)
                        print(f"{Fore.YELLOW}{rep} удалён из основной папки, так как в архиве уже есть файл с этой датой.")
                    except Exception as e:
                        print(f"{Fore.RED}Не удалось удалить {rep} из основной папки: {e}")
                else:
                    try:
                        shutil.move(rep, archive_dir)
                        print(f"{Fore.GREEN}{rep} перемещён в архив.")
                    except Exception as e:
                        print(f"{Fore.RED}Не удалось переместить {rep} в архив: {e}")

            # Фильтруем данные под текущий регион
            df_r = df_div.loc[df_div['Регион.Наименование'] == region].reset_index(drop=True)

            # Очищаем лист от предыдущих данных
            sh_data.clear_contents()

            # Заливаем отфильтрованный датафрейм на лист (без индекса)
            sh_data.range('A1').options(index=False).value = df_r

            # Добавляем таблицу (если нужно, можно проверять, существует ли уже "TDSheet")
            sh_data.tables.add(source=sh_data.range('A1').expand(), name='TDSheet')

            # Обновляем сводные таблицы
            wb.api.RefreshAll()

            # Переключаемся на лист "Соблюдение оплаты" (если он есть)
            try:
                wb.sheets['Соблюдение оплаты'].activate()
            except:
                pass  # Если такого листа нет, просто игнорируем

            # Формируем имя файла для сохранения
            report_name = datetime.today().strftime('%Y%m%d') + '_Отчёт по ДЗ_' + region + '.xlsx'
            report_path = os.path.join(reports_dir, report_name)

            # Сохраняем книгу под новым именем, если такого файла ещё нет
            if not os.path.exists(report_path):
                try:
                    wb.save(report_path)
                except Exception as e:
                    print(f"{Fore.RED}Ошибка при сохранении файла для региона {region}: {e}")
            else:
                print(f"{Fore.YELLOW}{region} - файл с таким именем уже существует, пропускаем.")

            # Выводим время обработки региона
            region_end_time = time.time()
            print(f"{Fore.GREEN}{region} - обработано. Время обработки: {(region_end_time - region_start_time):.2f} секунд")

    # Закрываем книгу и завершаем процесс Excel
    wb.close()
    app_excel.kill()

    # Выводим общее время работы программы
    end_time = time.time()
    print(f'Общее время работы программы: {(end_time - start_time) / 60:.2f} минут(ы).')


# Точка входа при запуске скрипта напрямую
if __name__ == "__main__":
    payment_by_region()
